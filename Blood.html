<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æ™ºæ…§è¡€å£“è¾¨è­˜ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #2c3e50; color: white; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: #34495e; padding: 20px; border-radius: 15px; }
        
        /* æ¨™é¡Œèˆ‡æŒ‰éˆ•çš„æ’ç‰ˆ */
        .header-area { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; /* è®“å…§å®¹æ’é–‹ */
            margin-bottom: 20px; 
            position: relative;
        }

        /* ç¶ åº•ç™½å­—å›é¦–é æŒ‰éˆ• */
        .home-btn {
            background-color: #27ae60; 
            color: white; 
            text-decoration: none;
            padding: 10px 18px; 
            border-radius: 6px; 
            font-weight: bold;
            font-size: 0.95em;
            transition: background 0.3s;
        }
        .home-btn:hover { background-color: #1e8449; }

        /* å³å´è¡¨æ ¼æŒ‰éˆ• */
        .view-btn { 
            background-color: #2980b9; 
            color: white; 
            text-decoration: none; 
            padding: 10px 18px; 
            border-radius: 6px; 
            font-weight: bold; 
            font-size: 0.95em;
            transition: background 0.3s;
        }
        .view-btn:hover { background-color: #3498db; }

        .image-container { position: relative; display: inline-block; margin: 15px 0; border: 2px solid #95a5a6; }
        #image-preview { display: block; max-height: 300px; width: auto; max-width: 100%; border-radius: 5px; }
        
        .result-container { display: flex; justify-content: space-around; margin: 20px 0; gap: 15px; flex-wrap: wrap; }
        .group-res { background: #1a252f; padding: 20px; border-radius: 10px; flex: 1; min-width: 200px; border-bottom: 4px solid #3498db; }
        .digit-val { font-size: 3.5em; color: #f1c40f; font-family: monospace; font-weight: bold; margin: 10px 0; }
        
        .status-box { border-bottom: 4px solid #2ecc71; }
        #diagnosis-text { font-size: 2.5em; font-weight: bold; margin: 15px 0; }
        .normal { color: #2ecc71; }
        .abnormal { color: #e74c3c; }

        #debug-view { display: none; }
        #save-status { color: #2ecc71; margin-top: 10px; font-weight: bold; height: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-area">
        <a href="homepage.html" class="home-btn">ğŸ  å›é¦–é </a>
        
        <h2 id="status-title" style="margin: 0;">æ™ºæ…§è¡€å£“è¾¨è­˜ç³»çµ±</h2>
        
        <a href="https://docs.google.com/spreadsheets/d/1u1lHW5aOVmKmtyw84URwpYsyb8_ZjhBBpZ4K_NXLpxs/edit?usp=sharing" target="_blank" class="view-btn">ğŸ“Š æŸ¥çœ‹é›²ç«¯è¡¨æ ¼</a>
    </div>
    
    <input type="file" id="file-input" accept="image/*">
    <div id="save-status"></div>
    
    <div class="image-container">
        <img id="image-preview" src="#" alt="åœ–ç‰‡é è¦½" style="display:none;">
    </div>
    
    <div class="result-container">
        <div class="group-res">
            <div>æœ€é«˜è¡€å£“ (Y)</div>
            <div id="res-0" class="digit-val">---</div>
        </div>
        <div class="group-res">
            <div>æœ€ä½è¡€å£“ (X)</div>
            <div id="res-1" class="digit-val">---</div>
        </div>
        <div class="group-res status-box">
            <div>è¿´æ­¸è¨ºæ–·</div>
            <div id="diagnosis-text">---</div>
        </div>
    </div>

    <div id="debug-view"><div id="canvas-list"></div></div>
</div>

<script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxOSEfUVaZ-niTVvpru3zQ58XMb-R1P-m9BMo-LJWyb1y_cE-ssjWfbvtBcuHGvIuM/exec"; 
    const URL = "https://teachablemachine.withgoogle.com/models/953dWkYhC/"; 
    let model;

    const regions = [
        [0.18, 0.24, 0.30, 0.18],
        [0.54, 0.24, 0.28, 0.18]
    ];

    async function init() {
        try {
            const cacheBust = "?t=" + new Date().getTime();
            model = await tmImage.load(URL + "model.json" + cacheBust, URL + "metadata.json" + cacheBust);
        } catch(e) { 
            document.getElementById("status-title").innerText = "âŒ æ¨¡å‹è¼‰å…¥å¤±æ•—";
        }
    }

    const fileInput = document.getElementById('file-input');
    const imagePreview = document.getElementById('image-preview');

    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            imagePreview.src = event.target.result;
            imagePreview.style.display = "block";
            imagePreview.onload = () => processLayout();
        };
        reader.readAsDataURL(file);
    });

    async function processLayout() {
        const w = imagePreview.naturalWidth;
        const h = imagePreview.naturalHeight;
        document.getElementById('canvas-list').innerHTML = "";
        document.getElementById('save-status').innerText = "è¾¨è­˜ä¸­...";

        let finalResults = [];

        for (let r = 0; r < regions.length; r++) {
            const [rx, ry, rw, rh] = regions[r];
            let groupResult = "";

            for (let d = 0; d < 3; d++) {
                const canvas = document.createElement('canvas');
                const dw = (w * rw) / 3; 
                const dh = h * rh;
                canvas.width = dw; canvas.height = dh;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(imagePreview, (w * rx) + (d * dw), h * ry, dw, dh, 0, 0, dw, dh);
                document.getElementById('canvas-list').appendChild(canvas);

                const prediction = await model.predict(canvas);
                const best = prediction.reduce((p, c) => (p.probability > c.probability) ? p : c);
                
                if (best.className !== "background" && best.className !== "X" && best.probability > 0.2) {
                    groupResult += best.className;
                }
            }
            document.getElementById(`res-${r}`).innerText = groupResult || "---";
            finalResults.push(groupResult);
        }

        checkBloodPressureRange(finalResults[0], finalResults[1]);
        saveToExcel(finalResults[0], finalResults[1]);
    }

    function checkBloodPressureRange(yStr, xStr) {
        const Y = parseFloat(yStr);
        const X = parseFloat(xStr);
        const diagElement = document.getElementById("diagnosis-text");

        if (isNaN(Y) || isNaN(X)) {
            diagElement.innerText = "ç­‰å¾…æ•¸æ“š";
            diagElement.className = "";
            return;
        }

        const theoreticalY = (-0.2196 * X) + 142.5;
        const margin = 3.163849;
        const upperLimit = theoreticalY + margin;
        const lowerLimit = theoreticalY - margin;

        if (Y >= lowerLimit && Y <= upperLimit) {
            diagElement.innerText = "æ­£å¸¸";
            diagElement.className = "normal";
        } else {
            diagElement.innerText = "ä¸æ­£å¸¸";
            diagElement.className = "abnormal";
        }
    }

    async function saveToExcel(res0, res1) {
        try {
            await fetch(GOOGLE_SCRIPT_URL, {
                method: "POST",
                mode: "no-cors",
                body: JSON.stringify({ res0: res0, res1: res1 }),
                headers: { "Content-Type": "application/json" }
            });
            document.getElementById('save-status').innerText = "âœ… æ•¸æ“šå·²å„²å­˜è‡³é›²ç«¯";
        } catch (e) {
            document.getElementById('save-status').innerText = "âŒ é›²ç«¯å„²å­˜å¤±æ•—";
        }
    }

    init();
</script>
</body>
</html>

    init();
</script>
</body>

</html>
